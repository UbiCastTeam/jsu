class JavaScriptUtilities{constructor(){this.version=11,this.ignoreUntilFocusChanges=!1,this.userAgent=window.navigator&&window.navigator.userAgent?window.navigator.userAgent.toLowerCase():"unknown",this.userAgentData=null,this.osName="",this.osVersion="",this.browserName="",this.browserVersion="",this.isTactile=!1,this.isMobile=!1,this._translations={en:{}},this._currentLang="en",this._currentCatalog=this._translations.en,this._getOSInfo(),this._getBrowserInfo(),this._overrideHttpRequest(),window.jsu?this.version!=window.jsu.version&&(console.warn('Another version of jsu.js was already imported, jsu will be replaced by most recent version. Version: "'+this.version+'", other version: "'+window.jsu.version+'".'),window.jsu.version<this.version&&(window.jsu=this)):window.jsu=this}getCookie(e,t=""){if(document.cookie.length>0){let t=document.cookie.indexOf(e+"=");if(-1!=t){t=t+e.length+1;let n=document.cookie.indexOf(";",t);return-1==n&&(n=document.cookie.length),window.decodeURIComponent(document.cookie.substring(t,n))}}return t}setCookie(e,t,n=360){const s=new Date;s.setDate(s.getDate()+n);const i=0===window.location.href.indexOf("https://")?"; secure; samesite=none":"";document.cookie=e+"="+window.decodeURIComponent(t)+"; expires="+s.toUTCString()+"; path=/"+i}strip(e,t=""){if(!e)return e;const n=""!==t?t:" \n\r\t ";let s=0;for(;s<e.length&&-1!=n.indexOf(e[s]);)s++;let i=e.length-1;for(;i>=0&&-1!=n.indexOf(e[i]);)i--;return e.substring(s,i+1)}slugify(e){return e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^-\w]+/g,"").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}stripHTML(e){if(!e)return e;const t=document.createElement("div");return t.innerHTML=e,t.textContent}decodeHTML(e){if(!e)return"";const t=document.createElement("div");return t.innerHTML=e,0===t.childNodes.length?"":t.childNodes[0].nodeValue}escapeHTML(e){if(!e)return e;let t=e.toString();return t=(t=(t=(t=t.replace(/(&)/g,"&amp;")).replace(/(<)/g,"&lt;")).replace(/(>)/g,"&gt;")).replace(/(\n)/g,"<br/>")}escapeAttribute(e){if(!e)return e;let t=e.toString();return t=(t=(t=t.replace(/(")/g,"&quot;")).replace(/(')/g,"&#39;")).replace(/(\n)/g,"&#13;&#10;")}getClickPosition(e,t){let n=t,s=0,i=0;for(;null!=n;)s+=n.offsetLeft,i+=n.offsetTop,n=n.offsetParent;return{x:e.pageX-s,y:e.pageY-i}}onDOMLoad(e){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(e,1):document.addEventListener("DOMContentLoaded",e)}httpRequest(e){const t=e.params?e.params:{};e.cache||(t._=(new Date).getTime());const n=e.method?e.method.toUpperCase():"GET";let s=e.url?e.url:"";const i=e.headers?e.headers:{};if(!/^(GET|HEAD|OPTIONS|TRACE)$/.test(n)){const e=this.getCookie("csrftoken");e&&(i["X-CSRFToken"]=e)}const r=[];for(const e in t)if(t[e]instanceof Array)for(const n of t[e])r.push(encodeURIComponent(e)+"="+encodeURIComponent(n));else r.push(encodeURIComponent(e)+"="+encodeURIComponent(t[e]));let o;if(r.length>0&&(s+=(-1===s.indexOf("?")?"?":"&")+r.join("&")),e.jsonData)i["Content-Type"]="application/json; charset=UTF-8",o=e.data;else if(e.data instanceof FormData)o=e.data;else if(e.data){o=new FormData;for(const t in e.data)if(e.data[t]instanceof Array)for(const n of e.data[t])o.append(t+"[]",n);else o.append(t,e.data[t])}else o=null;const a=new XMLHttpRequest;e.progress&&a.upload&&a.upload.addEventListener("progress",e.progress,!1),e.callback&&(a.addEventListener("readystatechange",function(){if(this.readyState!==XMLHttpRequest.DONE)return;if(a._callbackCalled)return;let t;if(a._callbackCalled=!0,e.json)if(""===this.responseText)t={error:"No response.",empty:!0,raw:this.responseText};else try{t=JSON.parse(this.responseText)}catch(e){t={error:"Failed to parse json response: "+e,raw:this.responseText}}else t=this.responseText;e.callback(this,t)}),a.addEventListener("error",function(t){if(a._callbackCalled)return;a._callbackCalled=!0;const n=t.error||t.message||(t.detail?t.detail.error||t.detail.message:"Unknown error");e.callback(this,{error:n})})),a.open(n,s,!e.synchronous);for(const e in i)if(i[e]instanceof Array)for(const t of i[e])a.setRequestHeader(e,t);else a.setRequestHeader(e,i[e]);return a.send(o),a}compareVersions(e,t,n){t="="==t?"==":t;const s=e.split("."),i=n.split("."),r=Math.max(s.length,i.length);for(let e=0;e<r;e++){const t=Number(s[e]),n=Number(i[e]);if(t<n)return 1;if(t>n)return-1}return 0}setObjectAttributes(e,t,n=null){if(t){"translations"in t&&(this.addTranslations(t.translations),delete t.translations);for(const s in t)n&&-1==n.indexOf(s)||(e[s]=t[s])}}getWebglContext(e,t={},n=""){if(window.WebGLRenderingContext)try{let s;return(s="safari"===n?e.getContext("webgl",t)||e.getContext("experimental-webgl",t):e.getContext("webgl2",t)||e.getContext("webgl",t)||e.getContext("experimental-webgl",t))||(console.log("Failed to initialize WebGL context. Your browser does not support Webgl context."),null)}catch(e){return console.log("WebGL context is supported but may be disable, please check your browser configuration."),null}return console.log("Your browser does not support Webgl context"),null}isInIframe(){return!(!window.frameElement||"IFRAME"!=window.frameElement.nodeName)}attemptFocus(e){if(!this.isFocusable(e))return!1;this.ignoreUntilFocusChanges=!0;try{e.focus()}catch(t){console.log("Failed to focus element.",e,t)}return this.ignoreUntilFocusChanges=!1,document.activeElement===e}isFocusable(e){if(e.tabIndex>0||0===e.tabIndex&&null!==e.getAttribute("tabIndex"))return!0;if(e.disabled)return!1;switch(e.nodeName){case"A":return!!e.href&&"ignore"!=e.rel;case"INPUT":return"hidden"!=e.type&&"file"!=e.type;case"BUTTON":case"SELECT":case"TEXTAREA":return!0;default:return!1}}focusFirstDescendant(e){for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];if(this.attemptFocus(n)||this.focusFirstDescendant(n))return!0}return!1}focusLastDescendant(e){for(let t=e.childNodes.length-1;t>=0;t--){const n=e.childNodes[t];if(this.attemptFocus(n)||this.focusLastDescendant(n))return!0}return!1}_getOSInfo(){let e,t;if(!e&&window.navigator&&window.navigator.platform){const n=window.navigator.platform.toLowerCase();-1==n.indexOf("ipad")&&-1==n.indexOf("iphone")&&-1==n.indexOf("ipod")||(e="ios",t=parseFloat((""+(/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))||!1)}if(!e&&window.navigator&&window.navigator.appVersion){const t=window.navigator.appVersion.toLowerCase();-1!=t.indexOf("win")?e="windows":-1!=t.indexOf("mac")?e="macos":-1==t.indexOf("x11")&&-1==t.indexOf("linux")||(e="linux")}this.osName=e||"unknown",this.osVersion=t||0}_getBrowserInfo(){let e,t=0;if(window.navigator&&window.navigator.userAgentData&&window.navigator.userAgentData.brands)for(let n=0;n<window.navigator.userAgentData.brands.length;n++){const s=window.navigator.userAgentData.brands[n];if(s){if(-1!=(e=s.brand.toLowerCase()).indexOf("brand"))continue;t=parseFloat(s.version),"google chrome"==e||"chromium"==e?e="chrome":"microsoft edge"==e&&(e="edge"),this.userAgentData=window.navigator.userAgentData;break}}if(!e&&this.userAgent){const n=function(e,t){const n=e.match(t);if(n&&!isNaN(parseInt(n[1],10))){let e="";if(!isNaN(parseInt(n[2],10)))for(e=n[2];e.length<10;)e="0"+e;return e=n[1]+"."+e,parseFloat(e)}return 0},s=this.userAgent;-1!=s.indexOf("firefox")?(e="firefox",(t=n(s,/firefox\/(\d+)\.(\d+)/))||(t=n(s,/rv:(\d+)\.(\d+)/))):-1!=s.indexOf("edge")?(e="edge",t=n(s,/edge\/(\d+)\.(\d+)/)):-1!=s.indexOf("chromium")?(e="chromium",t=n(s,/chromium\/(\d+)\.(\d+)/)):-1!=s.indexOf("chrome")?(e="chrome",t=n(s,/chrome\/(\d+)\.(\d+)/)):-1!=s.indexOf("iemobile")?(e="iemobile",t=n(s,/iemobile\/(\d+)\.(\d+)/)):-1!=s.indexOf("msie")?(e="ie",t=n(s,/msie (\d+)\.(\d+)/)):-1!=s.indexOf("trident")?(e="ie",t=n(s,/rv.{1}(\d+)\.(\d+)/)):-1!=s.indexOf("opera")?(e="opera",t=n(s,/opera\/(\d+)\.(\d+)/)):-1!=s.indexOf("konqueror")?(e="konqueror",t=n(s,/konqueror\/(\d+)\.(\d+)/)):-1!=s.indexOf("mobile safari")?(e="mobile_safari",t=n(s,/mobile safari\/(\d+)\.(\d+)/)):-1!=s.indexOf("safari")&&(e="safari",t=n(s,/version\/(\d+)\.(\d+)/))}if(window.navigator&&window.navigator.userAgentData)this.isMobile=Boolean(window.navigator.userAgentData.mobile);else{const e=this.userAgent;this.isMobile=-1!=e.indexOf("iphone")||-1!=e.indexOf("ipod")||-1!=e.indexOf("android")||-1!=e.indexOf("iemobile")||-1!=e.indexOf("opera mobi")||-1!=e.indexOf("opera mini")||-1!=e.indexOf("windows ce")||-1!=e.indexOf("fennec")||-1!=e.indexOf("series60")||-1!=e.indexOf("symbian")||-1!=e.indexOf("blackberry")||void 0!==window.orientation||window.navigator&&"iPad"==window.navigator.platform}this.isTactile=document.documentElement&&"ontouchstart"in document.documentElement,this.browserName=e||"unknown",this.browserVersion=t}isRecordingAvailable(){return"safari"===this.browserName?!this.isMobile&&this.browserVersion>=16:!this.isMobile}isLivestreamingAvailable(){return this.isRecordingAvailable()&&"firefox"!==this.browserName}useLang(e){this._currentLang=e,this._translations[e]||(this._translations[e]={}),this._currentCatalog=this._translations[e]}getCurrentLang(){return this._currentLang}getCurrentCatalog(){return this._currentCatalog}addTranslations(e,t=""){let n;t?(this._translations[t]||(this._translations[t]={}),n=this._translations[t]):n=this._currentCatalog;for(const t of Object.keys(e))e[t]&&(n[t]=e[t])}translate(e,t=""){const n=(t?t+"":"")+e;return n in this._currentCatalog?this._currentCatalog[n]:"en"!=this._currentLang&&n in this._translations.en?this._translations.en[n]:e}translateHTML(e,t=""){const n=this.translate(e,t);return this.escapeHTML(n)}translateAttribute(e,t=""){const n=this.translate(e,t);return this.escapeAttribute(n)}getDateDisplay(e){if(!e)return"";const t=/^(\d+)-(\d+)-(\d+)(?: |T)(\d+):(\d+):(\d+)$/.exec(e);if(!t)return e;const n=t[1];let s=null;switch(t[2]){case"01":s=this.translate("January");break;case"02":s=this.translate("February");break;case"03":s=this.translate("March");break;case"04":s=this.translate("April");break;case"05":s=this.translate("May");break;case"06":s=this.translate("June");break;case"07":s=this.translate("July");break;case"08":s=this.translate("August");break;case"09":s=this.translate("September");break;case"10":s=this.translate("October");break;case"11":s=this.translate("November");break;case"12":s=this.translate("December")}const i=t[3];let r,o=parseInt(t[4],10),a=parseInt(t[5],10);if(!s||isNaN(o)||isNaN(a))return e;if(a<10&&(a="0"+a),"en"!==this._currentLang)o<10&&(o="0"+o),r=o+":"+a;else{let e;o<12?(e="AM",o||(o=12)):(e="PM",o>12&&(o-=12)),r=o+":"+a+" "+e}return i+" "+s+" "+n+" "+this.translate("at")+" "+r}getSizeDisplay(e){if(!e||isNaN(e))return"0 "+this.translate("B");let t="";return e>1e3&&(t="k",(e/=1e3)>1e3&&(t="M",(e/=1e3)>1e3&&(t="G",(e/=1e3)>1e3&&(e/=1e3,t="T")))),e.toFixed(1)+" "+t+this.translate("B")}getHashFromRequest(e,t,n,s={}){let i=e+t;if(i&&i.includes("_=")&&((i=i.replace(/_=[0-9]+&?/g,"")).endsWith("?")||i.endsWith("&"))&&(i=i.substring(0,i.length-1)),n instanceof FormData||n instanceof URLSearchParams)i+=JSON.stringify(Object.fromEntries(n));else if(n instanceof Blob)i+="blob-"+n.size;else if(n instanceof ArrayBuffer)i+="arraybuffer-"+n.byteLength;else if(n)try{i+=JSON.stringify(n)}catch(e){i+=JSON.stringify(new Date)}return Object.keys(s).length&&(i+=JSON.stringify(s)),i}parseSubtitle(e){const t=e.replace(/\r/g,"").split("\n\n"),n=[];let s=1;for(let e=0;e<t.length;e++){const i=t[e].split("\n");for(;i.length&&!i[0].includes(" --\x3e ");)i.shift();if(i.length>=2){const e=i[0].split(" --\x3e ");i.shift(),2==e.length&&(n.push({id:s,content:i.join(" ").trim(),timeStart:e[0].trim(),timeEnd:e[1].trim()}),s+=1)}}return n}subtitleToText(e){return this.parseSubtitle(e).map(e=>{let t=e.content;return t.endsWith(".")||t.endsWith("?")||t.endsWith("!")?t+="\n\n":t+=" ",t}).join("")}_overrideHttpRequest(){window.xhrOverride=!0;const e=[];XMLHttpRequest.noIntercept=!1;const t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,n){return this._method=e,this._url=n,t.apply(this,arguments)};const n=XMLHttpRequest.prototype.setRequestHeader;XMLHttpRequest.prototype.setRequestHeader=function(e,t){const s=n.apply(this,arguments);return this._headers||(this._headers={}),this._headers[e]||(this._headers[e]=[]),this._headers[e].push(t),s};const s=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(t){const n=window.jsu.getHashFromRequest(this._method,this._url,t,this._headers);if(e.includes(n)){const e="Duplicated request aborted";return Object.defineProperty(this,"statusText",{value:e,writable:!1}),this.dispatchEvent(new CustomEvent("error",{detail:{error:e,message:e}}))}return e.push(n),this.noIntercept||this.addEventListener&&this.addEventListener("readystatechange",function(){this.readyState===XMLHttpRequest.DONE&&e.splice(e.indexOf(n),1)},!1),s.apply(this,arguments)}}}class ChunkedUpload{constructor(e){const t=["file","uploadURL","completeURL"],n={debugMode:null,extraHeaders:{},extraData:{},maxRetry:30,retryDelay:1e4,chunkSize:2e7,fileNameSuffix:"",progressCallback:null,retryCallback:null,successCallback:null,failureCallback:null,inTest:!1};for(const n of t){if(!e[n])throw new Error('A mandatory argument is missing: "'+n+'".');this[n]=e[n]}for(const t in n)this[t]=void 0!==e[t]?e[t]:n[t];null===this.debugMode&&-1!==window.location.hash.indexOf("debug")&&(this.debugMode=!0),this.sendFile()}logDebug(){this.debugMode&&!this.inTest&&console.log.apply(null,arguments)}logError(){this.inTest||console.error.apply(null,arguments)}logWarn(){this.inTest||console.warn.apply(null,arguments)}onProgress(e){this.progressCallback&&this.progressCallback(e)}onRetry(e,t){let n;if(this.retryCallback&&(n=this.retryCallback(e)),void 0===n){const e=this;n=new Promise(function(t){e.logDebug("Retrying in "+e.retryDelay+" ms..."),setTimeout(t,e.retryDelay)})}n.then(t)}onSuccess(){this.successCallback&&this.successCallback(this.uploadId)}onFailure(e){this.failureCallback&&this.failureCallback(e)}sendFile(){if(this.onProgress(0),this.uploadId=null,this.fileName=this.file.name,this.fileNameSuffix){const e=this.fileName.lastIndexOf(".");this.fileName=e>0?this.fileName.substring(0,e)+this.fileNameSuffix+this.fileName.substring(e):"file"+this.fileNameSuffix+".tmp"}this.logDebug("Number of chunk to send:",Math.ceil(this.file.size/this.chunkSize),this.chunkSize,this.file.size),this.sendNextChunk(0,0)}sendNextChunk(e,t){this.logDebug("Sending chunk:","start:",e,"total size:",this.file.size,"retries:",t);const n=Math.min(e+this.chunkSize,this.file.size),s=new FormData;s.append("file",this.file.slice(e,n),this.fileName),s.append("retries",t),this.uploadId&&s.append("upload_id",this.uploadId);for(const e in this.extraData)s.append(e,this.extraData[e]);const i=(n-e)/this.file.size,r=Object.assign(this.extraHeaders,{"Content-Range":"bytes "+e+"-"+(n-1)+"/"+this.file.size});this.logDebug("Content-Range",r["Content-Range"]);const o=this;jsu.httpRequest({method:"POST",url:this.uploadURL,headers:r,data:s,json:!0,progress:function(t){if(t.lengthComputable){let n=e/o.file.size;t.total&&(n+=i*(t.loaded/t.total)),n=Math.floor(95*n),o.logDebug("Progress:",n,i,t.loaded,t.total),o.onProgress(n)}},callback:function(s,i){if(200==s.status&&i.upload_id){o.logDebug("Chunk sent",i),o.uploadId=i.upload_id;const e=n;e>=o.file.size?o.completeUpload(0):o.sendNextChunk(e,0)}else o.logError("Failed to send chunk:",i),t<o.maxRetry?(void 0!==i.offset&&e!==i.offset&&(o.logWarn("Jumping from offset "+e+" to "+i.offset),e=i.offset),o.onRetry(s,o.sendNextChunk.bind(o,e,t+1))):o.onFailure(i.error)}})}completeUpload(e){this.logDebug("Calling complete:","expected size:",this.file.size,"retries:",e);const t=new FormData;t.append("upload_id",this.uploadId),t.append("expected_size",this.file.size),t.append("retries",e);for(const e in this.extraData)t.append(e,this.extraData[e]);const n=this;jsu.httpRequest({method:"POST",url:this.completeURL,headers:this.extraHeaders,data:t,json:!0,callback:function(t,s){200==t.status&&s.upload_id?(n.logDebug("Complete succeeded:",s),n.onProgress(100),n.onSuccess()):(n.logError("Failed to call complete:",s),e<n.maxRetry?n.onRetry(t,n.completeUpload.bind(n,e+1)):n.onFailure(s.error))}})}}class PollingManager{constructor(e,t,n){this.enabled=!1,this.timeoutId=null,this.running=!1,this.lastRun=0,this.interval=t,this.fct=e,void 0!==n&&!0!==n||this.enable(),document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState?this.resume():this.cancel()}.bind(this))}enable(){this.enabled||(this.enabled=!0,this.resume())}disable(){this.enabled&&(this.enabled=!1,this.cancel())}run(){this.enabled&&!this.running&&(this.running=!0,this.cancel(),this.fct(function(e){this.lastRun=(new Date).getTime(),this.running=!1,void 0!==e&&!0!==e||this.plan(this.interval)}.bind(this)))}plan(e){this.enabled&&!this.timeoutId&&"visible"===document.visibilityState&&(this.timeoutId=setTimeout(this.run.bind(this),e))}resume(){const e=(new Date).getTime(),t=Math.max(this.lastRun+this.interval-e,1);this.plan(t)}cancel(){null!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}}new JavaScriptUtilities;